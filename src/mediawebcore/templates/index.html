<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Virtual Piano</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #111; overflow: hidden; }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: black;
        }
    </style>
</head>
<body>
    <canvas id="result_canvas"></canvas>

    <script>
        const socket = io({ transports: ['websocket'] });
        const canvas = document.getElementById('result_canvas');
        const ctx = canvas.getContext('2d');

        // ì „ì²´ í•´ìƒë„ ê¸°ì¤€
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // ê³ í™”ì§ˆ ì—…ìŠ¤ì¼€ì¼ë§
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";

        // ì¹´ë©”ë¼ì—ì„œ ì˜ìƒ ìº¡ì²˜
        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function (s) {
            const video = document.createElement('video');
            video.srcObject = s;
            video.play();

            const sendCanvas = document.createElement('canvas');
            const sendCtx = sendCanvas.getContext('2d');

            setInterval(() => {
                sendCanvas.width = 320;
                sendCanvas.height = 240;
                sendCtx.drawImage(video, 0, 0, 320, 240);

                sendCanvas.toBlob(function (blob) {
                    if (blob) {
                        socket.emit("frame_blob", blob);
                    }
                }, "image/webp", 0.5);
            }, 200);
        });

        /**
        * ğŸ“¦ ìˆ˜ì‹ ëœ í”„ë ˆì„ ì²˜ë¦¬
        * ì„œë²„ê°€ `{ frame_blob: ..., meta: { cropped: true, layout: 'bottom' } }` í˜•íƒœë¡œ ì „ì†¡í–ˆë‹¤ê³  ê°€ì •
        */
        socket.on("result_frame_blob", function (data) {
            let blobData = data;
            let layout = "full";

            // í”ŒëŸ¬ê·¸ì¸ì´ ë©”íƒ€ ì •ë³´ë¥¼ ê°™ì´ ë³´ë‚´ëŠ” ê²½ìš°
            if (data && data.hasOwnProperty('frame_blob') && data.hasOwnProperty('meta')) {
                blobData = data.frame_blob;
                layout = data.meta.layout || "full";  // 'full' or 'bottom'
            }

            const blob = new Blob([blobData], { type: "image/webp" });
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let targetW = canvas.width;
                let targetH = canvas.height;

                if (layout === "bottom") {
                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™”ë©´ ì•„ë˜ì— ë Œë”ë§
                    targetH = canvas.height * 0.3;
                    targetW = img.width / img.height * targetH;
                    const x = (canvas.width - targetW) / 2;
                    const y = canvas.height - targetH;
                    ctx.drawImage(img, x, y, targetW, targetH);
                } else {
                    // ì „ì²´ í™”ë©´
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                }
            };
            img.src = URL.createObjectURL(blob);
        });
    </script>

</body>
</html>
