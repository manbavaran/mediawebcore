<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Virtual Piano</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: #000;
            height: 100%;
            overflow: hidden;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: black;
        }
    </style>
</head>
<body>
    <canvas id="result_canvas"></canvas>

    <script>
    const socket = io({ transports: ['websocket'] });
    const canvas = document.getElementById('result_canvas');
    const ctx = canvas.getContext('2d');

    // 해상도 축소 전송 설정
    const SEND_WIDTH = 320;
    const SEND_HEIGHT = 240;

    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            const offscreen = document.createElement("canvas");
            const offCtx = offscreen.getContext("2d");

            setInterval(() => {
                offscreen.width = SEND_WIDTH;
                offscreen.height = SEND_HEIGHT;
                offCtx.drawImage(video, 0, 0, SEND_WIDTH, SEND_HEIGHT);

                offscreen.toBlob(blob => {
                    if (blob) socket.emit("frame_blob", blob);
                }, "image/jpeg", 0.4);  // 송신 화질은 낮게 유지
            }, 150);  // 약 6~7 FPS
        });

    socket.on("result_frame_blob", blobData => {
        const blob = new Blob([blobData], { type: "image/webp" });
        const img = new Image();

        img.onload = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        };

        img.src = URL.createObjectURL(blob);
    });
    </script>
</body>
</html>
