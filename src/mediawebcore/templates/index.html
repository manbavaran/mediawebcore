<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Virtual Piano</title>
    <style>
        body { margin: 0; background-color: black; overflow: hidden; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <canvas id="result_canvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({ transports: ['websocket'] });
        const canvas = document.getElementById("result_canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let renderMode = "default";
        let cropMode = false;
        let lastHeight = 0;

        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
            const video = document.createElement("video");
            video.srcObject = stream;
            video.play();

            const sendCanvas = document.createElement("canvas");
            const sendCtx = sendCanvas.getContext("2d");

            setInterval(() => {
                sendCanvas.width = 320;
                sendCanvas.height = 240;
                sendCtx.drawImage(video, 0, 0, 320, 240);
                sendCanvas.toBlob(blob => {
                    if (blob) socket.emit("frame_blob", blob);
                }, "image/webp", 0.5);
            }, 200);
        });

        socket.on("result_frame_blob", data => {
            const img = new Image();
            const blob = new Blob([data.image], { type: "image/webp" });
            renderMode = data.render_mode || "default";
            cropMode = data.cropped || false;
            lastHeight = data.height || 0;

            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (renderMode === "bottom" && cropMode && lastHeight > 0) {
                    ctx.drawImage(img, 0, canvas.height - img.height);
                } else {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                }
            };
            img.src = URL.createObjectURL(blob);
        });
    </script>
</body>
</html>
