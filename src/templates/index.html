<!-- mediawebcore/templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>mediawebcore Streaming</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        #video, #result_img {
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">mediawebcore 데모</h2>
    <video id="video"
        {% if width|string.endswith('%') %}
            style="width:{{ width }};height:auto;"
        {% else %}
            width="{{ width }}" height="{{ height }}"
        {% endif %}
        autoplay muted></video>
    <img id="result_img"
        {% if width|string.endswith('%') %}
            style="width:{{ width }};height:auto;"
        {% else %}
            width="{{ width }}" height="{{ height }}"
        {% endif %}
    />
    <script>
    // 카메라 연결, 프레임 캡처/전송, 수신 이미지 표시
    const video = document.getElementById('video');
    const result_img = document.getElementById('result_img');
    let stream, captureInterval;

    // 서버 연결
    const socket = io();

    // 카메라 스트림 시작
    navigator.mediaDevices.getUserMedia({video: true, audio: false})
        .then(function(s) {
            stream = s;
            video.srcObject = stream;
            video.play();

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            captureInterval = setInterval(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg');
                socket.emit('frame', dataUrl);
            }, 50); // 20fps
        });

    // 처리 결과 프레임 수신
    socket.on('result_frame', function(resultData) {
        result_img.src = resultData;
    });
    </script>
</body>
</html>
